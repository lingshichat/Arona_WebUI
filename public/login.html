<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>身份验证 | 什亭之箱</title>
  <link rel="stylesheet" href="/assets/fontawesome/css/all.min.css">
  <style>
    :root {
      --primary-color: #3b70fc;
      --glass-bg: rgba(20, 30, 60, 0.55);
      --glass-border: rgba(255, 255, 255, 0.15);
      --text-primary: #ffffff;
      --text-muted: rgba(255, 255, 255, 0.6);
      --bg-image: url('/assets/bg.jpg');
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      color: var(--text-primary);
      background: var(--bg-image) no-repeat center center fixed;
      background-size: cover;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    body::before {
      content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--backdrop-color, rgba(0, 10, 30, 0.65));
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); z-index: 0;
    }
    .login-container {
      position: relative; z-index: 1;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 40px 50px;
      width: 100%; max-width: 440px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4), inset 0 0 0 1px rgba(255, 255, 255, 0.1);
      text-align: center;
      backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
      animation: floatIn 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    @keyframes floatIn { 
      from { opacity: 0; transform: translateY(30px) scale(0.96); filter: blur(4px); } 
      to { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); } 
    }
    .avatar {
      width: 90px; height: 90px; border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, 0.9);
      margin-bottom: 24px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .avatar:hover { transform: scale(1.08) rotate(5deg); }
    h2 { 
      margin: 0 0 8px; font-weight: 600; font-size: 24px; letter-spacing: 3px; 
      background: linear-gradient(135deg, #fff 0%, #b3c5ff 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    p { margin: 0 0 32px; font-size: 15px; color: var(--text-muted); font-weight: 300; }
    
    .input-group { position: relative; margin-bottom: 24px; text-align: left; }
    .input-group label {
      display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 8px; letter-spacing: 1px; text-transform: uppercase;
    }
    .input-wrapper { position: relative; }
    .input-wrapper i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.5); font-size: 14px; transition: color 0.3s; }
    
    input {
      width: 100%; padding: 14px 16px 14px 44px;
      background: rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px; color: #fff; font-size: 15px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    input::placeholder { color: rgba(255,255,255,0.3); }
    input:focus { 
      outline: none; border-color: var(--primary-color); 
      background: rgba(0, 0, 0, 0.45);
      box-shadow: 0 0 0 3px rgba(59, 112, 252, 0.2), inset 0 2px 4px rgba(0,0,0,0.2);
    }
    input:focus + i { color: var(--primary-color); }
    
    button {
      width: 100%; padding: 15px; margin-top: 8px;
      background: linear-gradient(135deg, #3b70fc 0%, #667eea 100%);
      border: none; border-radius: 12px;
      color: white; font-size: 16px; font-weight: 600; letter-spacing: 1px;
      cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative; overflow: hidden;
      box-shadow: 0 8px 20px rgba(59, 112, 252, 0.3);
    }
    button::after {
      content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transform: skewX(-20deg); transition: 0.5s;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 12px 25px rgba(59, 112, 252, 0.4); }
    button:hover::after { left: 150%; }
    button:active { transform: translateY(1px); box-shadow: 0 4px 10px rgba(59, 112, 252, 0.3); }
    
    #error-msg { 
      color: #ff6b6b; font-size: 14px; margin-top: 20px; min-height: 20px; 
      opacity: 0; transform: translateY(-5px); transition: all 0.3s;
    }
    #error-msg.show { opacity: 1; transform: translateY(0); }
    
    .loading-spinner {
      display: none; width: 20px; height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: #fff; border-radius: 50%;
      animation: spin 1s linear infinite;
      position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
    }
    @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
    .btn-text { transition: opacity 0.3s; }
    button.loading .btn-text { opacity: 0; }
    button.loading .loading-spinner { display: block; }
  </style>
  <script src="/theme.js"></script>
</head>
<body>
  <div class="login-container">
    <img src="/assets/avatar.jpg" alt="Arona" class="avatar">
    <h2>什亭之箱</h2>
    <p>Sensei, 欢迎回来。请验证您的终端权限。</p>
    
    <div class="input-group">
      <label>用户 (Username)</label>
      <div class="input-wrapper">
        <input type="text" id="username" placeholder="请输入管理员账号" autocomplete="off" />
        <i class="fa-solid fa-user"></i>
      </div>
    </div>

    <div class="input-group" style="margin-bottom: 32px;">
      <label>凭证 (Password)</label>
      <div class="input-wrapper">
        <input type="password" id="password" placeholder="请输入认证密码" autocomplete="off" />
        <i class="fa-solid fa-lock"></i>
      </div>
    </div>

    <button type="button" id="login-btn" onclick="login()">
      <span class="btn-text">授权访问</span>
      <div class="loading-spinner"></div>
    </button>
    <div id="error-msg"></div>
  </div>

  <script>
    document.getElementById('password').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') login();
    });
    document.getElementById('username').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('password').focus();
    });

    async function login() {
      const user = document.getElementById('username').value.trim();
      const pwd = document.getElementById('password').value.trim();
      const errorMsg = document.getElementById('error-msg');
      const btn = document.getElementById('login-btn');
      const btnText = btn.querySelector('.btn-text');
      
      errorMsg.classList.remove('show');
      
      if (!user || !pwd) {
        errorMsg.textContent = "账号和密码都需要填写哦，老师！";
        errorMsg.classList.add('show');
        shake();
        return;
      }
      
      btn.classList.add('loading');
      btn.disabled = true;

      try {
        const res = await fetch("/api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: user, password: pwd })
        });
        
        const data = await res.json();
        
        if (data.ok) {
          btn.classList.remove('loading');
          btnText.textContent = "验证通过";
          btn.style.background = "linear-gradient(135deg, #10b981 0%, #34d399 100%)";
          btn.style.boxShadow = "0 8px 20px rgba(16, 185, 129, 0.4)";
          localStorage.setItem("openclaw_token", data.token);
          
          setTimeout(() => {
            window.location.href = "/";
          }, 600);
        } else {
          throw new Error(data.error || "认证失败");
        }
      } catch (err) {
        setTimeout(() => {
          errorMsg.textContent = err.message;
          errorMsg.classList.add('show');
          btn.classList.remove('loading');
          btn.disabled = false;
          shake();
        }, 300); // 稍微延迟展示错误，让加载动画有点存在感
      }
    }

    function shake() {
      const container = document.querySelector('.login-container');
      container.style.animation = "none";
      container.offsetHeight; // trigger reflow
      container.style.animation = "shake 0.4s cubic-bezier(0.36, 0.07, 0.19, 0.97) both";
    }
  </script>
  <style>
    @keyframes shake {
      10%, 90% { transform: translate3d(-2px, 0, 0); }
      20%, 80% { transform: translate3d(4px, 0, 0); }
      30%, 50%, 70% { transform: translate3d(-6px, 0, 0); }
      40%, 60% { transform: translate3d(6px, 0, 0); }
    }
  </style>
</body>
</html>
